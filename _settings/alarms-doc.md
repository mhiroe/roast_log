# Artisan アラーム設定ドキュメント

## 概要
Artisanのアラーム設定は、ロースト中の重要なポイントで通知を行うための機能です。
設定はJSONファイル形式で保存され、複数のアラームを同時に設定できます。

## インターフェースとパラメータの対応

| インターフェース | JSON パラメータ | 説明 |
|----------------|----------------|------|
| Nr             | -              | アラーム番号（自動採番） |
| Status         | alarmflags     | アラームの有効/無効 |
| if Alarm       | alarmguard     | このアラームが有効になる前に発生している必要がある他のアラームのインデックスを指定 |
| But Not        | alarmnegguard  | このアラームが有効になる前に発生していてはいけない他のアラームのインデックスを指定 |
| From           | alarmguards    | 開始フェーズ |
| Time           | alarmtime      | アラームが有効になるタイミングを指定 |
| Source         | alarmsources   | 温度ソース |
| Condition      | alarmconds     | 条件 |
| Value          | alarmtemperatures | 温度値 |
| Action         | alarmactions   | アクション |
| Beep           | alarmbeep      | アラーム音 |
| Description    | alarmstrings   | 説明文 |
| Offset         | alarmoffset    | タイムドアラームの場合、alarmtime後に何秒でアラームを発生させるかを指定 |
| State          | alarmstate     | アラームの発生状態 |

## パラメータ詳細説明

### 1. Status (alarmflags)
- 説明：アラームの有効/無効を制御
- 値：
  - ON: 有効（1）
  - OFF: 無効（0）

### 2. if Alarm (alarmguard)
- 説明：このアラームが有効になる前に発生している必要がある他のアラームのインデックスを指定
- 値：
  - -1: ガード条件なし
  - 0以上の整数: 指定されたインデックスのアラームが発生している必要がある

### 3. But Not (alarmnegguard)
- 説明：このアラームが有効になる前に発生していてはいけない他のアラームのインデックスを指定
- 値：
  - -1: ネガティブガード条件なし
  - 0以上の整数: 指定されたインデックスのアラームが発生していてはいけない

### 4. From (alarmguards)
- 説明：アラームを開始するフェーズを指定
- 値：
  - CHARGE: 投入（1）
  - DRY: 乾燥（2）
  - FCs: 一番割れ開始（3）
  - FC: 一番割れ中（4）
  - SCs: 二番割れ開始（5）
  - SC: 二番割れ中（6）
  - DROP: 排出（7）
  - COOL: 冷却（8）

### 5. Time (alarmtime)
- 説明：アラームが有効になるタイミングを指定
- 値：
  - -1: START（開始時）
  - 0: CHARGE（投入時）
  - 1: DRY END（乾燥終了時）
  - 2: FCs（一番割れ開始時）
  - 3: FCe（一番割れ終了時）
  - 4: SCs（二番割れ開始時）
  - 5: SCe（二番割れ終了時）
  - 6: DROP（排出時）
  - 7: COOL（冷却時）
  - 8: TP（ターニングポイント時）
  - 9: ON（常時有効）
  - 10: If Alarm（条件付き）

### 6. Source (alarmsources)
- 説明：温度測定ソースの指定
- 値：
  - None: なし（-3）
  - DeltaET: ET変化率（-2）
  - DeltaBT: BT変化率（-1）
  - ET: 環境温（0）
  - BT: 豆温（1）
  - Extra1: 追加温度1（2）
  - Extra2-1: 追加温度2-1（3）
  - Extra2-2: 追加温度2-2（4）

### 7. Condition (alarmconds)
- 説明：アラーム条件の設定
- 値：
  - <: 指定温度以下でアラーム（0）
  - >: 指定温度以上でアラーム（1）
  - =: 指定温度と等しい（2）
  - ≠: 指定温度と等しくない（3）

### 8. Value (alarmtemperatures)
- 説明：アラーム温度の設定
- 値：実数値で温度を指定（℃）

### 9. Action (alarmactions)
- 説明：アラーム時のアクション設定
- 値：
  - -1: アクションなし
  - 0: ウィンドウを開く
  - 1: alarmstringで指定されたファイルパスのプログラムを実行
  - 2: 説明で指定された番号のボタンを有効化
  - 3-6: 説明で指定された値でスライダーを移動
  - 7: START（開始）
  - 8: DRY（乾燥）
  - 9: FCs（一番割れ開始）
  - 10: FCe（一番割れ終了）
  - 11: SCs（二番割れ開始）
  - 12: SCe（二番割れ終了）
  - 13: DROP（排出）
  - 14: COOL（冷却）
  - 15: OFF（終了）
  - 16: CHARGE（投入）
  - 17: RampSoak_ON
  - 18: RampSoak_OFF
  - 19: PID_ON
  - 20: PID_OFF

### 10. Beep (alarmbeep)
- 説明：アラーム音の有効/無効
- 値：
  - ON: 有効（1）
  - OFF: 無効（0）

### 11. Description (alarmstrings)
- 説明：アラームの説明文
- 値：文字列（任意のメッセージ）
- 注意：日本語を含む任意の文字列を設定可能

### 12. Offset (alarmoffset)
- 説明：タイムドアラームの場合、alarmtime後に何秒でアラームを発生させるかを指定
- 値：秒数（整数）

### 13. State (alarmstate)
- 説明：アラームの発生状態
- 値：
  - -1: 未発生
  - 0以上の整数: 発生済み（インデックス値）

## 設定例

### 標準的なロースティングアラーム設定
```json
{
    "alarmflags": [1, 1, 1, 1],
    "alarmguards": [1, 2, 3, 4],
    "alarmnegguards": [0, 0, 0, 0],
    "alarmtimes": [-1, -1, -1, 1200],
    "alarmoffsets": [0, 0, 0, 30],
    "alarmconds": [1, 1, 1, 1],
    "alarmsources": [1, 1, 1, 1],
    "alarmtemperatures": [160.0, 175.0, 195.0, 205.0],
    "alarmactions": [8, 9, 11, 13],
    "alarmbeep": [1, 1, 1, 1],
    "alarmstrings": [
        "乾燥フェーズ開始 160℃",
        "一番割れ開始 175℃",
        "二番割れ開始 195℃",
        "排出温度到達 205℃"
    ]
}
```

### ガード条件を使用したアラーム設定例
```json
{
    "alarmflags": [1, 1, 1],
    "alarmguard": [-1, 0, 1],
    "alarmnegguard": [-1, -1, -1],
    "alarmtime": [0, 2, 3],
    "alarmoffsets": [0, 30, 60],
    "alarmconds": [1, 1, 1],
    "alarmsources": [1, 1, 1],
    "alarmtemperatures": [150.0, 175.0, 190.0],
    "alarmactions": [8, 9, 10],
    "alarmbeep": [1, 1, 1],
    "alarmstrings": [
        "投入温度到達 150℃",
        "一番割れ開始予告 175℃（投入後）",
        "一番割れ終了予告 190℃（一番割れ開始後）"
    ]
}
```

## 追加の注意事項
1. `alarmoffsets`パラメータは、タイムドアラームの場合に、`alarmtime`後に何秒でアラームを発生させるかを指定します
2. サイレントアラーム機能（`silent_alarms`）が有効な場合、アラームは記録されますがアクションは実行されません
3. アラーム文字列（`alarmstrings`）では、#以降はコメントとして扱われます
4. すべての配列パラメータは同じ長さである必要があります
5. 温度値は摂氏（℃）で指定します
6. アラームの状態は新しいロースト開始時にリセットされます
7. アラームはプロファイルから読み込むことができます（`loadalarmsfromprofile`設定による）
8. バックグラウンドプロファイルからもアラームを読み込むことができます（`loadalarmsfrombackground`設定による）

## 注意事項
1. 温度はすべて摂氏（℃）で指定します
2. 配列の長さはすべて同じにする必要があります
3. アラーム音を使用する場合は、システムの音声出力が有効になっていることを確認してください
4. フェーズ指定（From）を使用する場合は、適切なフェーズ検出が設定されていることを確認してください
5. フェーズ番号は-1, 0-4の範囲で指定してください
6. alarmguardsは「if Alarm」と「From」の両方で使用されます 